@page "/contacts"
@using Microsoft.EntityFrameworkCore
@inject DataBaseService dataContext
@inject DialogService dialogService

<PageTitle>Contacts</PageTitle>
<RadzenCard class="rz-my-2 rz-mx-auto rz-p-2 rz-p-md-2" >
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px" class="mt-2 mb-4">
        <RadzenText Text="Contact" Style="font-weight:bold ; font-size: 35px"/>
        <RadzenSelectBar @bind-Value="@_selectedViewType">
            <Items>
                <RadzenSelectBarItem Text="Cartes" Value="@ViewType.Card"/>
                <RadzenSelectBarItem Text="Grille" Value="@ViewType.Grid"/>
            </Items>
        </RadzenSelectBar>
        <RadzenButton ButtonStyle="ButtonStyle.Primary" Icon="add_circle_outline" Text="Add Contact"
                      Click="@InsertRow" Disabled="@(_isEditMode)" Visible="@(_selectedViewType == ViewType.Grid)"/>
</RadzenStack>
</RadzenCard>

@if (_models == null)
{
    <RadzenText TextStyle="TextStyle.H5" Style="font-style:italic" class="rz-m-10">
        Loading Services...
    </RadzenText>
}
else if (_selectedViewType == ViewType.Grid)
{
    <RadzenDataGrid AllowMultiColumnSorting="true" AllowAlternatingRows="false" AllowFiltering="true"
                    FilterMode="FilterMode.Simple" AllowSorting="true" AllowColumnResize="true"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true" GridLines="DataGridGridLines.Vertical"
                    Data="@_models" ColumnWidth="300px" LogicalFilterOperator="LogicalFilterOperator.Or"
                    SelectionMode="DataGridSelectionMode.Single" TItem="ContactModel" @ref="_radzenDataGrid"
                    Density="Density.Compact" RowCreate="@OnCreateRow" RowUpdate="@OnUpdateRow">
        <Columns>
            <RadzenDataGridColumn Property="Surname" Title="Nom" Width="160px">
                <EditTemplate Context="ContactModel">
                    <RadzenTextBox @bind-Value="ContactModel.Surname" Style="width:140px; display: block" Name="Surname"/>
                    <RadzenRequiredValidator Text="Champ requis" Component="Surname" Popup="true"/>
                </EditTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="Name" Title="Prénom" Width="160px">
                <EditTemplate Context="ContactModel">
                    <RadzenTextBox @bind-Value="ContactModel.Name" Style="width:140px; display: block" Name="Name"/>
                </EditTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="Company" Title="Entreprise" Width="160px">
                <EditTemplate Context="ContactModel">
                    <RadzenTextBox @bind-Value="ContactModel.Company" Style="width:140px; display: block" Name="Compagny"/>
                    <RadzenRequiredValidator Text="Champ requis" Component="Compagny" Popup="true"/>
                </EditTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="Phone1" Title="Telephone 1"
                                  FormatString="{0:d}" Width="160px" Filterable="false">
                <EditTemplate Context="ContactModel">
                    <RadzenTextBox @bind-Value="ContactModel.Phone1" Style="width:140px; display: block" Name="Phone1"/>
                </EditTemplate>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="Mail" Title="Mail" Filterable="false">
                <EditTemplate Context="ContactModel">
                    <RadzenTextBox @bind-Value="ContactModel.Mail" Style="width:140px; display: block" Name="Mail"/>
                    <RadzenEmailValidator Text="mail incorrect" Component="Mail" Popup="true"/>
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn Context="ContactModel" Filterable="false" Sortable="false" TextAlign="TextAlign.Left"
                                  Frozen="true" FrozenPosition="FrozenColumnPosition.Right" Width="100">
                <Template Context="ContactModel">
                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => EditRow(ContactModel))" @onclick:stopPropagation="true">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat" Shade="Shade.Lighter" Size="ButtonSize.Medium" class="my-1 ms-1" Click="@(args => DeleteRow(ContactModel))" @onclick:stopPropagation="true">
                    </RadzenButton>
                </Template>
                <EditTemplate Context="ContactModel">
                    <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(args => SaveRow(ContactModel))" aria-label="Save">
                    </RadzenButton>
                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="my-1 ms-1" Click="@(args => CancelEdit(ContactModel))" aria-label="Cancel">
                    </RadzenButton>
                </EditTemplate>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}
else
{
    <RadzenDataList WrapItems="true" AllowPaging="true" Data="@_models" TItem="@ContactModel">
        <Template Context="contact">
            <RadzenCard Style="min-width: 300px ">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center">
                    <RadzenGravatar AlternateText="pas d'image" Email="@(contact.Name +contact.Surname)"/>
                    <RadzenStack Gap="0">
                        <RadzenText TextStyle="TextStyle.Overline" class="rz-display-flex rz-mt-2 rz-my-0">Nom</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1"><b>@(contact.Surname + " " + contact.Name)</b></RadzenText>
                        <RadzenText TextStyle="TextStyle.Overline" class="rz-display-flex rz-mt-4 rz-mb-0">Téléphone</RadzenText>
                        <RadzenText TextStyle="TextStyle.Body1"><b>@(contact.Phone1), @(contact.Phone2)</b></RadzenText>
                    </RadzenStack>
                </RadzenStack>
                <hr style="border: none; background-color: rgba(0,0,0,.2); height: 1px; margin: 1rem 0;" />
                <RadzenRow>
                    <RadzenColumn Size="8" Class="rz-text-truncate">
                        <b>@(contact.Company)</b>
                    </RadzenColumn>
                    <RadzenColumn Size="4" Class="rz-text-align-end">
                        <RadzenText Text="@contact.Job"/>
                        @* <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text=@($"{String.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", order.Freight)}")/> *@
                    </RadzenColumn>
                </RadzenRow>
            </RadzenCard>
        </Template>
    </RadzenDataList>
}

@code
{
    enum ViewType
    {
        Card,
        Grid
    }

    ViewType _selectedViewType;
    
    RadzenDataGrid<ContactModel>? _radzenDataGrid;
    IEnumerable<ContactModel>? _models;
    bool _isEditMode;

    protected override Task OnInitializedAsync()
    {
        _models = dataContext.GetAllContacts();
        return Task.CompletedTask;
    }

    async Task EditRow(ContactModel contactModel)
    {
        if (_radzenDataGrid == null)
        {
            return;
        }

        _isEditMode = true;
        await _radzenDataGrid.EditRow(contactModel);
    }

    async Task DeleteRow(ContactModel contactModel)
    {
        if (_models == null || _radzenDataGrid == null)
        {
            return;
        }

        var result = await dialogService.Confirm("Supprimer ce contact?",
            "Attention",
            new ConfirmOptions { OkButtonText = "Oui", CancelButtonText = "Non" });
        if (result == true)
        {
            if (_models.Contains(contactModel))
            {
                dataContext.Remove(contactModel);
                await _radzenDataGrid.Reload();
            }
        }
    }

    async Task SaveRow(ContactModel contactModel)
    {
        if (_radzenDataGrid == null)
        {
            return;
        }

        _isEditMode = false;
        await _radzenDataGrid.UpdateRow(contactModel);
    }

    void CancelEdit(ContactModel contactModel)
    {
        if (_radzenDataGrid == null)
        {
            return;
        }

        _isEditMode = false;
        _radzenDataGrid.CancelEditRow(contactModel);
        var contactEntry = dataContext.GetDb.Entry(contactModel);
        if (contactEntry.State != EntityState.Modified) return;
        contactEntry.CurrentValues.SetValues(contactEntry.OriginalValues);
        contactEntry.State = EntityState.Unchanged;
    }

    async Task InsertRow(MouseEventArgs mouseEventArgs)
    {
        if (_radzenDataGrid == null)
        {
            return;
        }

        _isEditMode = true;
        var contactToInsert = new ContactModel();
        await _radzenDataGrid.InsertRow(contactToInsert);
    }

    void OnCreateRow(ContactModel contactModel)
    {
        dataContext.Add(contactModel);
    }

    void OnUpdateRow(ContactModel contactModel)
    {
        dataContext.Update(contactModel);
        dataContext.Save();
    }
}